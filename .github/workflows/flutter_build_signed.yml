name: Flutter Android Signed Build (AAB + APK)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-android-signed:
    name: Build Android (signed AAB + APK)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.6'

      - name: Restore keystore (from secret)
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "ERROR: KEYSTORE_BASE64 secret is empty. Add your base64 keystore in repo Settings -> Secrets -> Actions"
            exit 1
          fi
          mkdir -p android/app
          echo "$KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks
          if [ ! -f android/app/upload-keystore.jks ]; then
            echo "ERROR: failed to create android/app/upload-keystore.jks"
            ls -la android || true
            exit 1
          fi
          echo "Keystore restored (size: $(stat -c%s android/app/upload-keystore.jks) bytes)"

      - name: Create key.properties for Gradle
        run: |
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=upload-keystore.jks" >> android/key.properties
          ls -la android/key.properties

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Build Release AAB (signed)
        run: flutter build appbundle --release

      - name: Build Release APK (signed)
        run: flutter build apk --release

      - name: List build outputs (debug)
        run: |
          echo "=== bundle files ==="
          ls -la build/app/outputs/bundle/release || true
          echo "=== apk files ==="
          ls -la build/app/outputs/flutter-apk || true

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: |
            build/app/outputs/bundle/release/*.aab
            build/app/outputs/flutter-apk/*.apk
