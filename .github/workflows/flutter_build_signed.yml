name: Flutter Android Signed Build (AAB + APK)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  # اگر pubspec.yaml در یک زیردایرکتوری است، این را به آن مسیر تغییر بده، مثال: "app"
  PROJECT_DIR: "."

jobs:
  build-android-signed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.6'

      - name: Restore keystore (from secret)
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "ERROR: KEYSTORE_BASE64 secret is empty. Add it in repo Settings -> Secrets -> Actions"
            exit 1
          fi

          # create path relative to PROJECT_DIR
          mkdir -p "${{ env.PROJECT_DIR }}/android/app"

          # decode into android/app/upload-keystore.jks
          echo "$KEYSTORE_BASE64" | base64 --decode > "${{ env.PROJECT_DIR }}/android/app/upload-keystore.jks"

          if [ ! -f "${{ env.PROJECT_DIR }}/android/app/upload-keystore.jks" ]; then
            echo "ERROR: failed to create keystore file"
            ls -la "${{ env.PROJECT_DIR }}/android" || true
            exit 1
          fi

          echo "Keystore restored (size: $(stat -c%s "${{ env.PROJECT_DIR }}/android/app/upload-keystore.jks") bytes)"

      - name: Create key.properties for Gradle
        run: |
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > "${{ env.PROJECT_DIR }}/android/key.properties"
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> "${{ env.PROJECT_DIR }}/android/key.properties"
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> "${{ env.PROJECT_DIR }}/android/key.properties"
          echo "storeFile=upload-keystore.jks" >> "${{ env.PROJECT_DIR }}/android/key.properties"
          ls -la "${{ env.PROJECT_DIR }}/android/key.properties"

      - name: Get Flutter dependencies
        run: flutter pub get
        working-directory: ${{ env.PROJECT_DIR }}

      - name: Build Release AAB (signed)
        run: flutter build appbundle --release
        working-directory: ${{ env.PROJECT_DIR }}

      - name: Build Release APK (signed)
        run: flutter build apk --release
        working-directory: ${{ env.PROJECT_DIR }}

      - name: Show build outputs
        run: |
          echo "=== bundle files ==="
          ls -la "${{ env.PROJECT_DIR }}/build/app/outputs/bundle/release" || true
          echo "=== apk files ==="
          ls -la "${{ env.PROJECT_DIR }}/build/app/outputs/flutter-apk" || true
        working-directory: ${{ env.PROJECT_DIR }}

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: |
            ${{ env.PROJECT_DIR }}/build/app/outputs/bundle/release/*.aab
            ${{ env.PROJECT_DIR }}/build/app/outputs/flutter-apk/*.apk
