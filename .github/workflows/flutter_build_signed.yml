name: Flutter Android Signed Build (AAB + APK)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  # اگر pubspec.yaml در فولدری غیر از روت است، این را به اسم آن فولدر تغییر بده
  PROJECT_DIR: "."

jobs:
  build-android-signed:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.6'

      - name: Show repo root (debug)
        run: |
          echo "PWD: $(pwd)"
          ls -la

      - name: Ensure project dir exists (debug)
        run: |
          echo "PROJECT_DIR=$PROJECT_DIR"
          ls -la "$PROJECT_DIR" || true

      - name: Restore keystore from secret
        run: |
          if [ -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "ERROR: KEYSTORE_BASE64 is empty. Add it in Settings -> Secrets -> Actions"
            exit 1
          fi
          mkdir -p "$PROJECT_DIR/android/app"
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > "$PROJECT_DIR/android/app/upload-keystore.jks"
          if [ ! -f "$PROJECT_DIR/android/app/upload-keystore.jks" ]; then
            echo "ERROR: failed to create keystore file"
            ls -la "$PROJECT_DIR/android" || true
            exit 1
          fi
          echo "Keystore restored OK: $(stat -c%s "$PROJECT_DIR/android/app/upload-keystore.jks") bytes"

      - name: Create android/key.properties
        run: |
          printf "storePassword=%s\nkeyPassword=%s\nkeyAlias=%s\nstoreFile=upload-keystore.jks\n" \
            "${{ secrets.KEYSTORE_PASSWORD }}" "${{ secrets.KEY_PASSWORD }}" "${{ secrets.KEY_ALIAS }}" \
            > "$PROJECT_DIR/android/key.properties"
          ls -la "$PROJECT_DIR/android/key.properties"

      - name: Flutter pub get
        run: |
          cd "$PROJECT_DIR"
          flutter pub get

      - name: Build AAB (release)
        run: |
          cd "$PROJECT_DIR"
          flutter build appbundle --release

      - name: Build APK (release)
        run: |
          cd "$PROJECT_DIR"
          flutter build apk --release

      - name: Collect artifacts
        run: |
          mkdir -p /tmp/artifacts
          cp "$PROJECT_DIR"/build/app/outputs/bundle/release/*.aab /tmp/artifacts/ 2>/dev/null || true
          cp "$PROJECT_DIR"/build/app/outputs/flutter-apk/*.apk /tmp/artifacts/ 2>/dev/null || true
          echo "Artifacts:"
          ls -la /tmp/artifacts || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: /tmp/artifacts/**
