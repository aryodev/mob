name: Flutter Android Signed Build (AAB + APK)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-android-signed:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.6'

      - name: Detect Flutter project directory
        id: detect
        run: |
          # Try git-indexed files first
          p="$(git ls-files | grep -m1 '^.*pubspec.yaml$' || true)"
          if [ -z "$p" ]; then
            p="$(find . -maxdepth 6 -type f -name pubspec.yaml -print -quit || true)"
          fi
          if [ -z "$p" ]; then
            echo "ERROR: no pubspec.yaml found in repository (search depth 6)."
            exit 1
          fi
          proj_dir="$(dirname "$p")"
          echo "Found pubspec.yaml at: $p"
          echo "PROJECT_DIR=$proj_dir" >> "$GITHUB_ENV"
          echo "::notice::Using PROJECT_DIR=$proj_dir"

      - name: Show project dir (debug)
        run: |
          echo "PROJECT_DIR=$PROJECT_DIR"
          ls -la "$PROJECT_DIR"
        env:
          PROJECT_DIR: ${{ env.PROJECT_DIR }}

      - name: Restore keystore (from secret)
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          PROJECT_DIR: ${{ env.PROJECT_DIR }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "ERROR: KEYSTORE_BASE64 secret is empty. Add KEYSTORE_BASE64 in repo Settings -> Secrets -> Actions"
            exit 1
          fi
          mkdir -p "$PROJECT_DIR/android/app"
          echo "$KEYSTORE_BASE64" | base64 --decode > "$PROJECT_DIR/android/app/upload-keystore.jks"
          if [ ! -f "$PROJECT_DIR/android/app/upload-keystore.jks" ]; then
            echo "ERROR: failed to create $PROJECT_DIR/android/app/upload-keystore.jks"
            ls -la "$PROJECT_DIR/android" || true
            exit 1
          fi
          echo "Keystore restored (size: $(stat -c%s "$PROJECT_DIR/android/app/upload-keystore.jks") bytes)"

      - name: Create key.properties for Gradle
        env:
          PROJECT_DIR: ${{ env.PROJECT_DIR }}
        run: |
          cat > "$PROJECT_DIR/android/key.properties" <<'EOF'
storePassword=${{ secrets.KEYSTORE_PASSWORD }}
keyPassword=${{ secrets.KEY_PASSWORD }}
keyAlias=${{ secrets.KEY_ALIAS }}
storeFile=upload-keystore.jks
EOF
          ls -la "$PROJECT_DIR/android/key.properties"

      - name: Get Flutter dependencies
        run: |
          cd "$PROJECT_DIR"
          flutter pub get

      - name: Build Release AAB (signed)
        run: |
          cd "$PROJECT_DIR"
          flutter build appbundle --release

      - name: Build Release APK (signed)
        run: |
          cd "$PROJECT_DIR"
          flutter build apk --release

      - name: Collect build artifacts
        env:
          PROJECT_DIR: ${{ env.PROJECT_DIR }}
        run: |
          rm -rf /tmp/artifacts || true
          mkdir -p /tmp/artifacts
          cp "$PROJECT_DIR"/build/app/outputs/bundle/release/*.aab /tmp/artifacts/ 2>/dev/null || true
          cp "$PROJECT_DIR"/build/app/outputs/flutter-apk/*.apk /tmp/artifacts/ 2>/dev/null || true
          echo "Artifacts in /tmp/artifacts:"
          ls -la /tmp/artifacts || true

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: /tmp/artifacts/**
